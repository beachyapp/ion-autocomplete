/*
 * ion-autocomplete 0.3.0
 * Copyright 2015 Danny Povolotski 
 * Copyright modifications 2015 Guy Brand 
 * https://github.com/guylabs/ion-autocomplete
 */
!function(){"use strict";angular.module("ion-autocomplete",[]).directive("ionAutocomplete",["$ionicBackdrop","$ionicScrollDelegate","$document","$q","$parse","$ionicPlatform","$compile","$templateRequest",function(a,b,c,d,e,f,g,h){return{require:["ngModel","ionAutocomplete"],restrict:"A",scope:{},bindToController:{ngModel:"=",templateData:"=",itemsMethod:"&",itemsClickedMethod:"&",itemsRemovedMethod:"&",modelToItemMethod:"&"},controllerAs:"viewModel",controller:["$attrs",function(a){var b=function(a,b){return a?a:b};this.placeholder=b(a.placeholder,"Click to enter a value..."),this.cancelLabel=b(a.cancelLabel,"true"===a.multipleSelect?"Done":"Cancel"),this.selectItemsLabel=b(a.selectItemsLabel,"Select an item..."),this.selectedItemsLabel=b(a.selectedItemsLabel,"Selected items:"),this.templateUrl=b(a.templateUrl,void 0),this.itemsMethodValueKey=b(a.itemsMethodValueKey,void 0),this.itemValueKey=b(a.itemValueKey,void 0),this.itemViewValueKey=b(a.itemViewValueKey,void 0),this.multipleSelect=b(a.multipleSelect,void 0),this.componentId=b(a.componentId,void 0),this.loadingIcon=b(a.loadingIcon,void 0),this.showLoadingIcon=!1,this.items=[],this.selectedItems=[],this.searchQuery=void 0}],link:function(i,j,k,l){var m,n=l[0],o=l[1],p="ion-autocomplete-random-"+Math.floor(1e3*Math.random()+1),q=['<div class="ion-autocomplete-container modal" style="display: none;">','<div class="bar bar-header item-input-inset">','<label class="item-input-wrapper">','<i class="icon ion-search placeholder-icon"></i>','<input type="search" class="ion-autocomplete-search" ng-model="viewModel.searchQuery" placeholder="{{viewModel.placeholder}}"/>',"</label>",'<div class="ion-autocomplete-loading-icon" ng-if="viewModel.showLoadingIcon && viewModel.loadingIcon"><ion-spinner icon="{{viewModel.loadingIcon}}"></ion-spinner></div>','<button class="ion-autocomplete-cancel button button-clear">{{viewModel.cancelLabel}}</button>',"</div>",'<ion-content class="has-header">','<ion-item class="item-divider" ng-show="viewModel.selectedItems.length > 0">{{viewModel.selectedItemsLabel}}</ion-item>','<ion-item ng-repeat="selectedItem in viewModel.selectedItems track by $index" class="item-icon-left item-icon-right">','<i class="icon ion-checkmark"></i>',"{{viewModel.getItemValue(selectedItem, viewModel.itemViewValueKey)}}",'<i class="icon ion-trash-a" style="cursor:pointer" ng-click="viewModel.removeItem($index)"></i>',"</ion-item>",'<ion-item class="item-divider" ng-show="viewModel.items.length > 0">{{viewModel.selectItemsLabel}}</ion-item>','<ion-item collection-repeat="item in viewModel.items" item-height="55px" item-width="100%" ng-click="viewModel.selectItem(item)">',"{{viewModel.getItemValue(item, viewModel.itemViewValueKey)}}","</ion-item>","</ion-content>","</div>"].join(""),r=function(a){return a.addClass(p)},s=function(a){return a.find("button").bind("click",function(){o.searchQuery=void 0,v()}),m=a.find("input"),a};o.templateUrl?h(o.templateUrl).then(function(a){c.find("body").append(s(r(g(angular.element(a))(i))))}):c.find("body").append(s(r(g(angular.element(q))(i)))),o.getItemValue=function(a,b){if(angular.isArray(a)){var c=[];return angular.forEach(a,function(d){b&&angular.isObject(a)?c.push(e(b)(d)):c.push(d)}),c}return b&&angular.isObject(a)?e(b)(a):a},o.selectItem=function(a){o.items=[],o.searchQuery=void 0,"true"===o.multipleSelect?(A(o.selectedItems,o.itemValueKey,o.getItemValue(a,o.itemValueKey))||(o.selectedItems=o.selectedItems.concat([a])),n.$setViewValue(o.selectedItems),n.$render()):(n.$setViewValue(a),n.$render(),v()),angular.isFunction(o.itemsClickedMethod)&&o.itemsClickedMethod({callback:{item:a,selectedItems:o.selectedItems.slice(),componentId:o.componentId}})},o.removeItem=function(a){var b=o.selectedItems.splice(a,1)[0];o.selectedItems=o.selectedItems.slice(),n.$setViewValue(o.selectedItems),n.$render(),angular.isFunction(o.itemsRemovedMethod)&&o.itemsRemovedMethod({callback:{item:b,selectedItems:o.selectedItems.slice(),componentId:o.componentId}})},i.$watch("viewModel.searchQuery",function(a){if(void 0!==a&&(""==a&&(o.items=[]),angular.isFunction(o.itemsMethod))){o.showLoadingIcon=!0;var c={query:a};o.componentId&&(c={query:a,componentId:o.componentId});var e=d.when(o.itemsMethod(c));e.then(function(a){a&&a.data&&(a=a.data),o.items=o.getItemValue(a,o.itemsMethodValueKey),b.resize(),o.showLoadingIcon=!1},function(a){return d.reject(a)})}});var t=!1,u=function(){t||(a.retain(),angular.element(c[0].querySelector("div.ion-autocomplete-container."+p)).css("display","block"),i.$deregisterBackButton=f.registerBackButtonAction(function(){v()},300),t=!0)},v=function(){angular.element(c[0].querySelector("div.ion-autocomplete-container."+p)).css("display","none"),a.release(),i.$deregisterBackButton&&i.$deregisterBackButton(),t=!1},w={moved:!1,startX:0,startY:0},x=function(a){w.moved=!1,"undefined"!=typeof a.originalEvent&&(a=a.originalEvent),w.startX=a.touches[0].clientX,w.startY=a.touches[0].clientY},y=function(a){"undefined"!=typeof a.originalEvent&&(a=a.originalEvent),(Math.abs(a.touches[0].clientX-w.startX)>10||Math.abs(a.touches[0].clientY-w.startY)>10)&&(w.moved=!0)},z=function(a){w.moved||(a.preventDefault(),a.stopPropagation(),u(),m.length>0&&(m[0].focus(),setTimeout(function(){m[0].focus()},0)),b.resize())},A=function(a,b,c){for(var d=0;d<a.length;d++)if(o.getItemValue(a[d],b)===c)return!0;return!1},B=function(a){var b=d.when(o.modelToItemMethod({modelValue:a}));b.then(function(a){o.selectItem(a)},function(a){return d.reject(a)})};j.bind("touchstart",x),j.bind("touchmove",y),j.bind("touchend click focus",z),angular.element(c[0].querySelector("div.ion-autocomplete-container."+p+" button")).bind("click",function(a){o.searchQuery=void 0,v()}),o.ngModel&&angular.isFunction(o.modelToItemMethod)&&("true"===o.multipleSelect&&angular.isArray(o.ngModel)?angular.forEach(o.ngModel,function(a){B(a)}):B(o.ngModel)),n.$render=function(){j.val(o.getItemValue(n.$viewValue,o.itemViewValueKey))},n.$formatters.push(function(a){var b=o.getItemValue(a,o.itemViewValueKey);return void 0==b?"":b}),n.$parsers.push(function(a){return o.getItemValue(a,o.itemValueKey)})}}}])}();