/*
 * ion-autocomplete 0.3.0
 * Copyright 2015 Danny Povolotski 
 * Copyright modifications 2015 Guy Brand 
 * https://github.com/guylabs/ion-autocomplete
 */
!function(){"use strict";angular.module("ion-autocomplete",[]).directive("ionAutocomplete",["$ionicBackdrop","$ionicScrollDelegate","$document","$q","$parse","$ionicPlatform","$compile","$templateRequest",function(a,b,c,d,e,f,g,h){return{require:["ngModel","ionAutocomplete"],restrict:"A",scope:{},bindToController:{ngModel:"=",templateData:"=",itemsMethod:"&",itemsClickedMethod:"&",itemsRemovedMethod:"&",modelToItemMethod:"&"},controllerAs:"viewModel",controller:["$attrs",function(a){var b=function(a,b){return a?a:b};this.placeholder=b(a.placeholder,"Click to enter a value..."),this.cancelLabel=b(a.cancelLabel,"true"===a.multipleSelect?"Done":"Cancel"),this.selectItemsLabel=b(a.selectItemsLabel,"Select an item..."),this.selectedItemsLabel=b(a.selectedItemsLabel,"Selected items:"),this.templateUrl=b(a.templateUrl,void 0),this.itemsMethodValueKey=b(a.itemsMethodValueKey,void 0),this.itemValueKey=b(a.itemValueKey,void 0),this.itemViewValueKey=b(a.itemViewValueKey,void 0),this.multipleSelect=b(a.multipleSelect,void 0),this.componentId=b(a.componentId,void 0),this.loadingIcon=b(a.loadingIcon,void 0),this.showLoadingIcon=!1,this.items=[],this.selectedItems=[],this.searchQuery=void 0}],link:function(i,j,k,l){var m=l[0],n=l[1],o="ion-autocomplete-random-"+Math.floor(1e3*Math.random()+1),p=['<div class="ion-autocomplete-container modal" style="display: none;">','<div class="bar bar-header item-input-inset">','<label class="item-input-wrapper">','<i class="icon ion-search placeholder-icon"></i>','<input type="search" class="ion-autocomplete-search" ng-model="viewModel.searchQuery" placeholder="{{viewModel.placeholder}}"/>',"</label>",'<div class="ion-autocomplete-loading-icon" ng-if="viewModel.showLoadingIcon && viewModel.loadingIcon"><ion-spinner icon="{{viewModel.loadingIcon}}"></ion-spinner></div>','<button class="ion-autocomplete-cancel button button-clear">{{viewModel.cancelLabel}}</button>',"</div>",'<ion-content class="has-header">','<ion-item class="item-divider" ng-show="viewModel.selectedItems.length > 0">{{viewModel.selectedItemsLabel}}</ion-item>','<ion-item ng-repeat="selectedItem in viewModel.selectedItems track by $index" class="item-icon-left item-icon-right">','<i class="icon ion-checkmark"></i>',"{{viewModel.getItemValue(selectedItem, viewModel.itemViewValueKey)}}",'<i class="icon ion-trash-a" style="cursor:pointer" ng-click="viewModel.removeItem($index)"></i>',"</ion-item>",'<ion-item class="item-divider" ng-show="viewModel.items.length > 0">{{viewModel.selectItemsLabel}}</ion-item>','<ion-item collection-repeat="item in viewModel.items" item-height="55px" item-width="100%" ng-click="viewModel.selectItem(item)">',"{{viewModel.getItemValue(item, viewModel.itemViewValueKey)}}","</ion-item>","</ion-content>","</div>"].join(""),q=function(a){return a.addClass(o)},r=function(a){return a.find("button").bind("click",function(){n.searchQuery=void 0,v()}),a};n.templateUrl?h(n.templateUrl).then(function(a){c.find("body").append(r(q(g(angular.element(a))(i))))}):c.find("body").append(r(q(g(angular.element(p))(i)))),n.getItemValue=function(a,b){if(angular.isArray(a)){var c=[];return angular.forEach(a,function(d){b&&angular.isObject(a)?c.push(e(b)(d)):c.push(d)}),c}return b&&angular.isObject(a)?e(b)(a):a};var s=angular.element(c[0].querySelector("div.ion-autocomplete-container."+o+" input"));n.selectItem=function(a){n.items=[],n.searchQuery=void 0,"true"===n.multipleSelect?(A(n.selectedItems,n.itemValueKey,n.getItemValue(a,n.itemValueKey))||(n.selectedItems=n.selectedItems.concat([a])),m.$setViewValue(n.selectedItems),m.$render()):(m.$setViewValue(a),m.$render(),v()),angular.isFunction(n.itemsClickedMethod)&&n.itemsClickedMethod({callback:{item:a,selectedItems:n.selectedItems.slice(),componentId:n.componentId}})},n.removeItem=function(a){var b=n.selectedItems.splice(a,1)[0];n.selectedItems=n.selectedItems.slice(),m.$setViewValue(n.selectedItems),m.$render(),angular.isFunction(n.itemsRemovedMethod)&&n.itemsRemovedMethod({callback:{item:b,selectedItems:n.selectedItems.slice(),componentId:n.componentId}})},i.$watch("viewModel.searchQuery",function(a){if(void 0!==a&&(""==a&&(n.items=[]),angular.isFunction(n.itemsMethod))){n.showLoadingIcon=!0;var c={query:a};n.componentId&&(c={query:a,componentId:n.componentId});var e=d.when(n.itemsMethod(c));e.then(function(a){a&&a.data&&(a=a.data),n.items=n.getItemValue(a,n.itemsMethodValueKey),b.resize(),n.showLoadingIcon=!1},function(a){return d.reject(a)})}});var t=!1,u=function(){t||(a.retain(),angular.element(c[0].querySelector("div.ion-autocomplete-container."+o)).css("display","block"),i.$deregisterBackButton=f.registerBackButtonAction(function(){v()},300),t=!0)},v=function(){angular.element(c[0].querySelector("div.ion-autocomplete-container."+o)).css("display","none"),a.release(),i.$deregisterBackButton&&i.$deregisterBackButton(),t=!1},w={moved:!1,startX:0,startY:0},x=function(a){w.moved=!1,"undefined"!=typeof a.originalEvent&&(a=a.originalEvent),w.startX=a.touches[0].clientX,w.startY=a.touches[0].clientY},y=function(a){"undefined"!=typeof a.originalEvent&&(a=a.originalEvent),(Math.abs(a.touches[0].clientX-w.startX)>10||Math.abs(a.touches[0].clientY-w.startY)>10)&&(w.moved=!0)},z=function(a){w.moved||(a.preventDefault(),a.stopPropagation(),u(),s.length>0&&(s[0].focus(),setTimeout(function(){s[0].focus()},0)),b.resize())},A=function(a,b,c){for(var d=0;d<a.length;d++)if(n.getItemValue(a[d],b)===c)return!0;return!1},B=function(a){var b=d.when(n.modelToItemMethod({modelValue:a}));b.then(function(a){n.selectItem(a)},function(a){return d.reject(a)})};j.bind("touchstart",x),j.bind("touchmove",y),j.bind("touchend click focus",z),angular.element(c[0].querySelector("div.ion-autocomplete-container."+o+" button")).bind("click",function(a){n.searchQuery=void 0,v()}),n.ngModel&&angular.isFunction(n.modelToItemMethod)&&("true"===n.multipleSelect&&angular.isArray(n.ngModel)?angular.forEach(n.ngModel,function(a){B(a)}):B(n.ngModel)),m.$render=function(){j.val(n.getItemValue(m.$viewValue,n.itemViewValueKey))},m.$formatters.push(function(a){var b=n.getItemValue(a,n.itemViewValueKey);return void 0==b?"":b}),m.$parsers.push(function(a){return n.getItemValue(a,n.itemValueKey)})}}}])}();